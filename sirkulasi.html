<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIRKULASI</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { 
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --bg-body: #f8f9fa; 
            --text-main: #202124; 
            --text-sub: #5f6368;
            --bg-card: #ffffff;
            --border-color: #dadce0;
            --input-bg: #f1f3f4;
            --primary-light: #e8f0fe;
            --modal-overlay: rgba(32, 33, 36, 0.4);
        }

        body.dark-theme { 
            --bg-body: #121212; 
            --text-main: #e8eaed; 
            --text-sub: #9aa0a6;
            --bg-card: #1e1e1e;
            --border-color: #3c4043;
            --input-bg: #2d2d2d;
            --primary-light: rgba(26, 115, 232, 0.2);
            --modal-overlay: rgba(0, 0, 0, 0.7);
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: 'Plus Jakarta Sans', sans-serif;
            height: 100vh; 
            display: flex; 
            align-items: flex-start; 
            justify-content: center; 
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
            padding-top: 20px;
        }

        .glass { 
            background: var(--bg-card); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); 
            border-radius: 20px;
        }
        
        input { 
            background: var(--input-bg) !important; 
            color: var(--text-main) !important; 
            border: 2px solid transparent !important; 
        }

        .autocomplete-list { 
            position: absolute;
            top: calc(100% + 8px);
            left: 0; right: 0;
            z-index: 1000;
            background: var(--bg-card); 
            border: 1px solid var(--border-color); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            border-radius: 16px;
            max-height: 280px;
            overflow-y: auto;
            padding: 4px;
        }

        .autocomplete-header {
            padding: 10px 14px 4px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            opacity: 0.6;
        }

        .autocomplete-item { 
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            border-radius: 12px;
            margin-bottom: 2px;
        }

        .autocomplete-item:hover, .autocomplete-item.selected { 
            background: var(--primary-light); 
        }

        #toast-container { 
            position: fixed; 
            bottom: 40px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 9999; 
        }
        
        .toast-msg { 
            background: var(--text-main); 
            color: var(--bg-card); 
            padding: 10px 20px; 
            border-radius: 50px; 
            font-size: 11px; 
            font-weight: 700; 
            display: flex;
            align-items: center;
            gap: 8px;
            animation: toastFast 0.2s ease-out;
        }

        @keyframes toastFast {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-container {
            position: fixed; inset: 0; z-index: 100;
            display: none; align-items: center; justify-content: center;
            padding: 20px; background: var(--modal-overlay);
            animation: fadeOverlay 0.1s linear;
        }

        .modal-fast {
            animation: modalQuick 0.1s ease-out;
            will-change: transform, opacity;
            transform: translateZ(0);
        }

        @keyframes modalQuick {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .btn-action {
            padding: 10px; border-radius: 12px; font-weight: 700; font-size: 10px;
            text-transform: uppercase; letter-spacing: 0.5px; transition: opacity 0.1s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:active { opacity: 0.8; }
        .btn-secondary { background: var(--input-bg); color: var(--text-main); }

        #summary-detail, #success-card { display: none; }
        
        .main-id-text {
            color: var(--primary);
            font-family: monospace;
            font-weight: 800;
            font-size: 1rem;
            line-height: 1;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="modal-confirm" class="modal-container">
    <div class="glass w-full max-w-[280px] p-6 modal-fast">
        <div class="text-center mb-4">
            <h4 class="text-sm font-extrabold">Konfirmasi</h4>
            <p id="modal-text" class="text-[11px] opacity-60 mt-2"></p>
        </div>
        <div class="flex gap-2">
            <button onclick="closeModal()" class="flex-1 btn-action btn-secondary">Batal</button>
            <button id="modal-confirm-btn" class="flex-1 btn-action btn-primary">Ya</button>
        </div>
    </div>
</div>

<div id="modal-date" class="modal-container">
    <div class="glass w-full max-w-[280px] p-6 modal-fast">
        <h4 class="text-sm font-extrabold mb-4 text-center">Ubah Tanggal</h4>
        <div class="space-y-3">
            <input type="date" id="customDatePicker" class="w-full p-3 rounded-xl outline-none text-xs font-semibold">
            <div class="flex gap-2">
                <button onclick="closeDateModal()" class="flex-1 btn-action btn-secondary">Batal</button>
                <button id="saveDateBtn" class="flex-1 btn-action btn-primary">Simpan</button>
            </div>
        </div>
    </div>
</div>

<div class="w-full max-w-[340px]">
    <div id="main-input-area" class="glass p-5">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                    <i class="fas fa-exchange-alt text-xs"></i>
                </div>
                <div>
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-blue-600">Sirkulasi</h3>
                </div>
            </div>
        </div>
        <div class="relative">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 opacity-30 text-xs"></i>
            <input type="text" id="inputMain" autocomplete="off" placeholder="Cari Anggota / ID..." class="w-full pl-10 pr-4 py-3 rounded-xl outline-none text-xs font-bold">
            <div id="listMain" class="autocomplete-list hidden"></div>
        </div>
    </div>

    <div id="summary-detail" class="glass p-5 border-t-4 border-blue-600">
        <div class="flex justify-between items-start mb-4">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-blue-600/10 text-blue-600 rounded-xl flex items-center justify-center text-sm">
                    <i class="fas fa-id-card"></i>
                </div>
                <div>
                    <h4 id="displayNis" class="main-id-text"></h4>
                    <p id="displayNama" class="text-xs font-bold leading-none"></p>
                </div>
            </div>
            <button onclick="resetKeAwal()" class="text-red-500 opacity-50 hover:opacity-100"><i class="fas fa-times"></i></button>
        </div>
        <div class="space-y-3">
            <div class="relative">
                <input type="text" id="inputBuku" autocomplete="off" placeholder="Cari Judul Buku..." class="w-full p-3 rounded-xl outline-none text-xs font-bold">
                <div id="listBuku" class="autocomplete-list hidden"></div>
            </div>
            <div id="bukuTerpilihBox" class="p-3 bg-blue-600/5 rounded-xl border border-blue-600/10 hidden">
                <p id="resJudul" class="font-bold text-[11px] leading-tight"></p>
                <div class="flex justify-between items-center mt-1">
                    <p id="resKode" class="text-[9px] font-black opacity-40 uppercase tracking-widest"></p>
                    <p id="resPengarang" class="text-[9px] font-bold text-blue-500"></p>
                </div>
            </div>
            <button id="btnProses" class="w-full py-3 btn-primary rounded-xl disabled:opacity-30" disabled onclick="handleSimpan()">Simpan Pinjaman</button>
        </div>
    </div>

    <div id="success-card" class="glass overflow-hidden">
        <div id="cardHeader" class="p-5 flex items-center gap-4 border-b border-slate-100 dark:border-white/5">
            <div id="iconStatus" class="w-12 h-12 rounded-2xl flex items-center justify-center text-white shrink-0"></div>
            <div class="flex-1 min-w-0">
                <h3 id="statusTitle" class="text-[10px] font-black uppercase tracking-wider opacity-60 mb-0.5"></h3>
                <p id="finalNama" class="text-sm font-extrabold truncate text-blue-600 dark:text-blue-400"></p>
            </div>
            <button onclick="resetKeAwal()" class="w-8 h-8 flex items-center justify-center rounded-xl bg-slate-100 dark:bg-white/10 hover:bg-red-500 hover:text-white"><i class="fas fa-times text-xs"></i></button>
        </div>

        <div class="p-5">
            <div class="mb-5 p-4 bg-slate-50 dark:bg-white/5 rounded-2xl border border-slate-100 dark:border-white/5">
                <div class="flex gap-3 mb-3">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/10 text-blue-500 flex items-center justify-center text-xs shrink-0"><i class="fas fa-book"></i></div>
                    <div class="flex-1 min-w-0">
                        <p id="finalBuku" class="font-bold text-[12px] leading-snug mb-1 truncate"></p>
                        <p id="finalKode" class="text-[9px] font-black opacity-40 tracking-widest uppercase"></p>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3 pt-3 border-t border-dashed border-slate-200 dark:border-white/10">
                    <div class="cursor-pointer" onclick="openDateModal()">
                        <span class="text-[8px] font-black uppercase opacity-40 block mb-1">Jatuh Tempo</span>
                        <div class="flex items-center gap-2">
                            <p id="finalTgl" class="font-bold text-[11px] text-red-500 flex items-center gap-1.5 bg-red-500/10 px-2 py-1 rounded-lg">
                                <span></span> <i class="fas fa-calendar-alt text-[8px]"></i>
                            </p>
                        </div>
                    </div>
                    <div>
                        <span class="text-[8px] font-black uppercase opacity-40 block mb-1">Total Denda</span>
                        <p id="finalDenda" class="font-bold text-[11px] text-orange-500 bg-orange-500/10 px-2 py-1 rounded-lg w-fit">Rp 0</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <button id="btnPerpanjang" class="py-3 bg-blue-600 text-white rounded-xl font-bold text-[10px] flex items-center justify-center gap-2">
                        <span class="bg-white/20 px-1.5 py-0.5 rounded text-[8px]">1</span> PERPANJANG
                    </button>
                    <button id="btnKembali" class="py-3 bg-red-600 text-white rounded-xl font-bold text-[10px] flex items-center justify-center gap-2">
                        <span class="bg-white/20 px-1.5 py-0.5 rounded text-[8px]">3</span> KEMBALI
                    </button>
                </div>
                <button onclick="resetKeAwal()" class="w-full py-3 bg-slate-900 dark:bg-white dark:text-slate-900 text-white rounded-xl font-bold text-[10px] flex items-center justify-center gap-2">
                    <span class="bg-slate-700 dark:bg-slate-200 px-1.5 py-0.5 rounded text-[8px]">2</span> SELESAI / BARU
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = { apiKey: "AIzaSyBB-vrCvxeSapbedNqQIfZ9Bh5de-sUDAQ", databaseURL: "https://databuku-6385c-default-rtdb.firebaseio.com", projectId: "databuku-6385c" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), rtdb = firebase.database();

    rtdb.ref('settings/dark_mode').on('value', snap => {
        document.body.classList.toggle('dark-theme', snap.val() === true);
    });

    let dataAnggota = [], allFlatData = [], dataPinjaman = [], selectedAnggota = null, selectedBuku = null, currentLoanDocId = null, currentFocus = -1, currentLoadedDate = null;

    db.collection("keanggotaan_v2").onSnapshot(s => dataAnggota = s.docs.map(d => ({id: d.id, ...d.data()})));
    db.collection("peminjaman_v2").where("status", "==", "DIPINJAM").onSnapshot(s => dataPinjaman = s.docs.map(d => ({id: d.id, ...d.data()})));
    
    rtdb.ref('data_flat').on('value', s => { 
        const d = s.val(); 
        allFlatData = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : []; 
    });

    window.addEventListener('DOMContentLoaded', () => document.getElementById("inputMain").focus());
    window.addEventListener('keydown', (e) => {
        if (["INPUT", "TEXTAREA"].includes(document.activeElement.tagName)) return;
        if (document.getElementById('success-card').style.display === 'block') {
            if (e.key === '1') document.getElementById('btnPerpanjang').click();
            if (e.key === '2') resetKeAwal();
            if (e.key === '3') document.getElementById('btnKembali').click();
        }
    });

    function showToast(msg) {
        const t = document.createElement('div'); 
        t.className = 'toast-msg'; 
        t.innerHTML = `<i class="fas fa-check-circle text-green-400"></i> ${msg}`;
        document.getElementById('toast-container').innerHTML = '';
        document.getElementById('toast-container').appendChild(t);
        setTimeout(() => { t.remove(); }, 2000);
    }

    function openModal(text, onConfirm, triggerBtnId) {
        document.getElementById('modal-text').textContent = text;
        const cb = document.getElementById('modal-confirm-btn');
        cb.disabled = false; 
        document.getElementById('modal-confirm').style.display = 'flex'; 
        cb.focus();
        cb.onclick = async () => { 
            cb.disabled = true; 
            if(triggerBtnId) document.getElementById(triggerBtnId).disabled = true; 
            await onConfirm(); 
            closeModal(); 
        };
    }
    function closeModal() { document.getElementById('modal-confirm').style.display = 'none'; }

    function openDateModal() {
        if(!currentLoanDocId) return;
        const dateString = currentLoadedDate.toISOString().split('T')[0];
        document.getElementById('customDatePicker').value = dateString;
        document.getElementById('modal-date').style.display = 'flex';
        document.getElementById('saveDateBtn').onclick = handleCustomDate;
    }
    function closeDateModal() { document.getElementById('modal-date').style.display = 'none'; }

    async function handleCustomDate() {
        const newDateVal = document.getElementById('customDatePicker').value;
        if(!newDateVal) return;
        const btn = document.getElementById('saveDateBtn');
        btn.disabled = true; btn.textContent = "...";
        try {
            const dateObj = new Date(newDateVal);
            await db.collection("peminjaman_v2").doc(currentLoanDocId).update({
                tgl_kembali: firebase.firestore.Timestamp.fromDate(dateObj)
            });
            showToast("Berhasil");
            currentLoadedDate = dateObj;
            renderSuccessData(dateObj);
            closeDateModal();
        } catch(e) { showToast("Gagal"); }
        btn.disabled = false; btn.textContent = "Simpan";
    }

    const inM = document.getElementById("inputMain"), lsM = document.getElementById("listMain");
    inM.addEventListener('input', () => {
        const q = inM.value.toLowerCase(); lsM.innerHTML = ''; currentFocus = -1;
        if(q.length < 1) return lsM.classList.add('hidden');
        
        const mP = dataPinjaman.filter(p => (p.nama_anggota||"").toLowerCase().includes(q) || (p.judul_buku||"").toLowerCase().includes(q) || (p.kode_ekslempar||"").toLowerCase().includes(q) || (p.anggota_id||"").toLowerCase().includes(q)).slice(0, 5);
        const pinjamIds = mP.map(p => p.anggota_id);

        const mA = dataAnggota.filter(a => 
            ((a.keanggotaan||"").toLowerCase().includes(q) || (a.id||"").toLowerCase().includes(q) || (a.kamarSantri||"").toLowerCase().includes(q)) && 
            !pinjamIds.includes(a.id)
        ).slice(0, 5);

        if(mA.length) {
            const h = document.createElement('div'); h.className = 'autocomplete-header'; h.textContent = 'Anggota (Baru)'; lsM.appendChild(h);
            mA.forEach(a => {
                const d = document.createElement('div'); d.className = 'autocomplete-item';
                d.innerHTML = `<i class="fas fa-id-card opacity-30 text-blue-600"></i> <div class="flex-1 min-w-0"><b class="main-id-text">${a.id}</b><br><small class="font-bold text-[11px] block truncate">${a.keanggotaan}</small></div>`;
                d.onclick = () => { selectedAnggota = a; checkActiveLoan(a); }; lsM.appendChild(d);
            });
        }

        if(mP.length) {
            const h = document.createElement('div'); h.className = 'autocomplete-header'; h.textContent = 'Data Pinjaman Aktif'; lsM.appendChild(h);
            mP.forEach(p => {
                const d = document.createElement('div'); d.className = 'autocomplete-item';
                d.innerHTML = `
                    <i class="fas fa-book-reader text-orange-500 shrink-0"></i> 
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-0.5">
                            <b class="text-[10px] font-black text-orange-500 uppercase truncate mr-2">${p.nama_anggota}</b>
                            <span class="text-[8px] font-black opacity-30 shrink-0">${p.kode_ekslempar}</span>
                        </div>
                        <small class="font-bold block text-[10px] leading-tight opacity-70 truncate">${p.judul_buku}</small>
                    </div>`;
                d.onclick = () => { currentLoanDocId = p.id; showSuccessCard(p.nama_anggota, p.judul_buku, p.kode_ekslempar, p.tgl_kembali.toDate(), true, p.anggota_id); lsM.classList.add('hidden'); };
                lsM.appendChild(d);
            });
        }
        
        lsM.classList.toggle('hidden', lsM.innerHTML === '');
    });

    async function checkActiveLoan(a) {
        lsM.classList.add('hidden'); inM.value = a.keanggotaan;
        const s = await db.collection("peminjaman_v2").where("anggota_id", "==", a.id).where("status", "==", "DIPINJAM").limit(1).get();
        if(!s.empty) { currentLoanDocId = s.docs[0].id; showSuccessCard(a.keanggotaan, s.docs[0].data().judul_buku, s.docs[0].data().kode_ekslempar, s.docs[0].data().tgl_kembali.toDate(), true, a.id); }
        else tampilkanDetail();
    }

    const inB = document.getElementById("inputBuku"), lsB = document.getElementById("listBuku");
    inB.addEventListener('input', () => {
        const q = inB.value.toLowerCase(); lsB.innerHTML = ''; if(q.length < 1) return lsB.classList.add('hidden');
        const m = allFlatData.filter(i => (i.judul||"").toLowerCase().includes(q) || (i.kode||"").toLowerCase().includes(q)).slice(0, 10);
        
        if(m.length) {
            const h = document.createElement('div'); h.className = 'autocomplete-header'; h.textContent = 'Buku'; lsB.appendChild(h);
            m.forEach(i => {
                const d = document.createElement('div'); d.className = 'autocomplete-item';
                let c = (i.kode || "-").trim(); 
                d.innerHTML = `<i class="fas fa-barcode opacity-30 text-emerald-500"></i> <div class="flex-1 min-w-0"><b class="main-id-text !text-emerald-500">${c}</b><br><small class='font-bold text-[11px] block truncate'>${i.judul}</small></div>`;
                d.onclick = () => { selectedBuku = { kode: c, judul: i.judul, pengarang: i.penulis || "-" }; inB.value = c; lsB.classList.add('hidden'); tampilkanBuku(); }; lsB.appendChild(d);
            });
        }
        lsB.classList.toggle('hidden', m.length === 0);
    });

    function setupK(i, l, e) {
        i.addEventListener("keydown", function(k) {
            let s = document.getElementById(l).getElementsByClassName("autocomplete-item");
            if (k.keyCode == 40) { currentFocus++; addA(s); } else if (k.keyCode == 38) { currentFocus--; addA(s); } 
            else if (k.keyCode == 13) { k.preventDefault(); if (currentFocus > -1 && s[currentFocus]) s[currentFocus].click(); else if (e) e(); }
        });
        function addA(s) { 
            if (!s || s.length === 0) return; 
            for (let x of s) x.classList.remove("selected"); 
            if (currentFocus >= s.length) currentFocus = 0; 
            if (currentFocus < 0) currentFocus = s.length - 1; 
            s[currentFocus].classList.add("selected"); 
            s[currentFocus].scrollIntoView({ block: "nearest" });
        }
    }
    setupK(inM, "listMain"); setupK(inB, "listBuku", () => { if(!document.getElementById("btnProses").disabled) handleSimpan(); });

    function tampilkanDetail() {
        document.getElementById("main-input-area").style.display = 'none';
        document.getElementById("displayNis").textContent = selectedAnggota.id;
        document.getElementById("displayNama").textContent = selectedAnggota.keanggotaan;
        document.getElementById("summary-detail").style.display = 'block'; 
        setTimeout(() => inB.focus(), 50);
    }
    function tampilkanBuku() {
        const box = document.getElementById("bukuTerpilihBox");
        box.classList.remove('hidden'); 
        document.getElementById("resJudul").textContent = selectedBuku.judul;
        document.getElementById("resKode").textContent = selectedBuku.kode; 
        document.getElementById("resPengarang").textContent = selectedBuku.pengarang; 
        document.getElementById("btnProses").disabled = false; 
        document.getElementById("btnProses").focus();
    }
    function resetKeAwal() {
        document.getElementById("success-card").style.display = 'none'; 
        document.getElementById("summary-detail").style.display = 'none';
        document.getElementById("main-input-area").style.display = 'block'; 
        document.getElementById("bukuTerpilihBox").classList.add('hidden');
        inM.value = ''; inB.value = ''; selectedAnggota = null; selectedBuku = null; currentLoanDocId = null; currentLoadedDate = null;
        document.getElementById("btnProses").disabled = true; document.getElementById("btnPerpanjang").disabled = false;
        document.getElementById("btnKembali").disabled = false; setTimeout(() => inM.focus(), 50);
    }

    function renderSuccessData(t) {
        const now = new Date(); now.setHours(0,0,0,0);
        const tempo = new Date(t); tempo.setHours(0,0,0,0); 
        const diff = Math.ceil((now - tempo) / (1000 * 60 * 60 * 24));
        document.getElementById("finalTgl").querySelector('span').textContent = t.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        document.getElementById("finalDenda").textContent = diff > 0 ? "Rp " + (diff * 1000).toLocaleString() : "Rp 0";
    }

    function showSuccessCard(n, j, k, t, e = false, idStr = "") {
        currentLoadedDate = t;
        document.getElementById("main-input-area").style.display = 'none'; 
        document.getElementById("summary-detail").style.display = 'none';
        document.getElementById("success-card").style.display = 'block'; 
        document.getElementById("statusTitle").textContent = e ? "Pinjaman Aktif" : "Transaksi Berhasil";
        document.getElementById("iconStatus").className = `w-12 h-12 rounded-2xl flex items-center justify-center text-white ${e ? 'bg-blue-600' : 'bg-green-500'}`;
        document.getElementById("iconStatus").innerHTML = `<i class="fas ${e ? 'fa-hourglass-half' : 'fa-check-circle'} text-lg"></i>`;
        document.getElementById("finalNama").textContent = n; 
        document.getElementById("finalBuku").textContent = j;
        document.getElementById("finalKode").textContent = k; 
        renderSuccessData(t);
        document.getElementById("btnPerpanjang").onclick = () => openModal("Perpanjang 4 hari?", handlePerpanjang, "btnPerpanjang");
        document.getElementById("btnKembali").onclick = () => openModal("Sudah kembali?", handleKembali, "btnKembali");
    }

    async function handleSimpan() {
        const b = document.getElementById("btnProses"); b.disabled = true;
        try {
            const tk = new Date(); tk.setDate(tk.getDate() + 4);
            const doc = await db.collection("peminjaman_v2").add({ 
                anggota_id: selectedAnggota.id, 
                nama_anggota: selectedAnggota.keanggotaan, 
                blok: selectedAnggota.kamarSantri || "-",
                kode_ekslempar: selectedBuku.kode, 
                judul_buku: selectedBuku.judul, 
                pengarang: selectedBuku.pengarang,
                tgl_pinjam: firebase.firestore.Timestamp.fromDate(new Date()), 
                tgl_kembali: firebase.firestore.Timestamp.fromDate(tk), 
                status: "DIPINJAM" 
            });
            currentLoanDocId = doc.id; 
            showToast("Berhasil"); 
            showSuccessCard(selectedAnggota.keanggotaan, selectedBuku.judul, selectedBuku.kode, tk, false, selectedAnggota.id);
        } catch(e) { b.disabled = false; showToast("Gagal"); }
    }
    
    async function handlePerpanjang() {
        const tb = new Date(currentLoadedDate); tb.setDate(tb.getDate() + 4);
        try { 
            await db.collection("peminjaman_v2").doc(currentLoanDocId).update({ tgl_kembali: firebase.firestore.Timestamp.fromDate(tb) }); 
            showToast("Berhasil"); currentLoadedDate = tb; renderSuccessData(tb);
            document.getElementById("btnPerpanjang").disabled = false; 
        } catch(e) { showToast("Gagal"); }
    }
    
    async function handleKembali() { 
        try { 
            await db.collection("peminjaman_v2").doc(currentLoanDocId).update({ status: "KEMBALI", tgl_dikembalikan: firebase.firestore.FieldValue.serverTimestamp() }); 
            showToast("Berhasil"); 
            setTimeout(() => resetKeAwal(), 500); 
        } catch(e) { showToast("Gagal"); } 
    }
</script>
</body>
</html>
